<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bike Trainer Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .video-section {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #111;
            overflow: hidden;
        }

        #youtube-player {
            width: 100%;
            height: 100%;
        }

        .video-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            gap: 16px;
        }

        .video-placeholder svg {
            width: 64px;
            height: 64px;
            opacity: 0.5;
        }

        /* í•¸ë“¤ë°” ì˜¤ë²„ë ˆì´ */
        .handlebar-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            pointer-events: none;
            display: none;
        }

        .handlebar-svg {
            width: 100%;
            height: 100%;
        }

        /* ì†ë„ ë¸”ëŸ¬ íš¨ê³¼ */
        .speed-blur {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .speed-blur::before,
        .speed-blur::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 15%;
            background: linear-gradient(to right, rgba(0,0,0,0.4), transparent);
        }

        .speed-blur::before {
            left: 0;
        }

        .speed-blur::after {
            right: 0;
            transform: scaleX(-1);
        }

        /* ê³„ê¸°íŒ ì˜¤ë²„ë ˆì´ */
        .dashboard-overlay {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
            pointer-events: none;
        }

        .gauge {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 16px;
            text-align: center;
            min-width: 80px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .gauge-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        .gauge-speed { color: #00ff88; }
        .gauge-cadence { color: #00aaff; }
        .gauge-power { color: #ffaa00; }
        .gauge-distance { color: #ff66aa; }
        .gauge-calories { color: #aa66ff; }
        .gauge-time { color: #ffffff; }

        .gauge-label {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ë°°ì† í‘œì‹œ */
        .playback-rate {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }

        .playback-rate.fast { color: #ff6644; }
        .playback-rate.normal { color: #00ff88; }
        .playback-rate.slow { color: #66aaff; }

        /* ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .pause-overlay.visible {
            opacity: 1;
        }

        .pause-overlay svg {
            width: 80px;
            height: 80px;
            color: #fff;
            margin-bottom: 16px;
            animation: pulse-icon 2s infinite;
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        .pause-overlay p {
            font-size: 18px;
            color: #888;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #0a0a0a;
        }

        .url-input-group {
            display: flex;
            gap: 8px;
        }

        .url-input-group input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #222;
            border-radius: 12px;
            background: #111;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .url-input-group input:focus {
            border-color: #00ff88;
        }

        .url-input-group input::placeholder {
            color: #444;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #00ff88;
            color: #000;
        }

        .btn-primary:hover {
            background: #00cc6a;
        }

        .btn-secondary {
            background: #222;
            color: #fff;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #333;
        }

        .btn-secondary.active {
            background: #00ff88;
            color: #000;
        }

        .btn-connect {
            background: linear-gradient(135deg, #0066ff, #0044cc);
            color: #fff;
            width: 100%;
        }

        .btn-connect:hover {
            background: linear-gradient(135deg, #0077ff, #0055dd);
        }

        .btn-connect.connected {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .button-row {
            display: flex;
            gap: 8px;
        }

        /* ì—°ê²° ìƒíƒœ */
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: #111;
            border-radius: 10px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-dot.connected {
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ë¼ì´ë”© ê¸°ë¡ */
        .ride-history {
            background: #111;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }

        .ride-history h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ride-history h3 button {
            background: none;
            border: none;
            color: #666;
            font-size: 12px;
            cursor: pointer;
        }

        .ride-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .ride-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 13px;
        }

        .ride-item-date {
            color: #666;
        }

        .ride-item-stats {
            display: flex;
            gap: 12px;
        }

        .ride-item-stats span {
            color: #aaa;
        }

        .no-rides {
            color: #444;
            font-size: 13px;
            text-align: center;
            padding: 20px;
        }

        /* ë©”ì‹œì§€ */
        .message {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .message.error {
            background: rgba(255, 68, 68, 0.15);
            color: #ff6666;
            display: block;
        }

        .message.info {
            background: rgba(0, 102, 255, 0.15);
            color: #66aaff;
            display: block;
        }

        .protocol-info {
            font-size: 11px;
            color: #444;
            text-align: center;
        }

        /* ì´ ê¸°ë¡ */
        .total-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            background: #111;
            border-radius: 12px;
        }

        .total-stat {
            text-align: center;
        }

        .total-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #00ff88;
        }

        .total-stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë¹„ë””ì˜¤ ì„¹ì…˜ -->
        <div class="video-section">
            <div id="player-container">
                <div class="video-placeholder" id="placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                    </svg>
                    <p>ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
                <div id="youtube-player"></div>
            </div>

            <!-- ì†ë„ ë¸”ëŸ¬ íš¨ê³¼ -->
            <div class="speed-blur" id="speed-blur"></div>

            <!-- ë°°ì† í‘œì‹œ -->
            <div class="playback-rate" id="playback-rate">1.0x</div>

            <!-- ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ -->
            <div class="pause-overlay" id="pause-overlay">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <p>í˜ë‹¬ì„ ë°Ÿìœ¼ë©´ ì¬ìƒë©ë‹ˆë‹¤</p>
            </div>

            <!-- ê³„ê¸°íŒ ì˜¤ë²„ë ˆì´ -->
            <div class="dashboard-overlay" id="dashboard">
                <div class="gauge">
                    <div class="gauge-value gauge-speed" id="speed-value">0.0</div>
                    <div class="gauge-label">km/h</div>
                </div>
                <div class="gauge">
                    <div class="gauge-value gauge-cadence" id="cadence-value">0</div>
                    <div class="gauge-label">RPM</div>
                </div>
                <div class="gauge">
                    <div class="gauge-value gauge-power" id="power-value">0</div>
                    <div class="gauge-label">W</div>
                </div>
                <div class="gauge">
                    <div class="gauge-value gauge-distance" id="distance-value">0.00</div>
                    <div class="gauge-label">km</div>
                </div>
                <div class="gauge">
                    <div class="gauge-value gauge-calories" id="calories-value">0</div>
                    <div class="gauge-label">kcal</div>
                </div>
                <div class="gauge">
                    <div class="gauge-value gauge-time" id="time-value">00:00</div>
                    <div class="gauge-label">ì‹œê°„</div>
                </div>
            </div>

            <!-- í•¸ë“¤ë°” ì˜¤ë²„ë ˆì´ -->
            <div class="handlebar-overlay" id="handlebar">
                <svg class="handlebar-svg" viewBox="0 0 400 80" preserveAspectRatio="xMidYMax slice">
                    <defs>
                        <linearGradient id="handleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#333;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#111;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- í•¸ë“¤ë°” -->
                    <path d="M0,80 L0,50 Q50,30 100,35 L150,40 Q200,45 200,45 Q200,45 250,40 L300,35 Q350,30 400,50 L400,80 Z" fill="url(#handleGrad)"/>
                    <!-- ê·¸ë¦½ ì™¼ìª½ -->
                    <rect x="20" y="45" width="60" height="20" rx="10" fill="#222" stroke="#444" stroke-width="1"/>
                    <!-- ê·¸ë¦½ ì˜¤ë¥¸ìª½ -->
                    <rect x="320" y="45" width="60" height="20" rx="10" fill="#222" stroke="#444" stroke-width="1"/>
                    <!-- ìŠ¤í…œ -->
                    <rect x="185" y="50" width="30" height="30" rx="3" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
                </svg>
            </div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel">
            <div class="url-input-group">
                <input type="text" id="youtube-url" placeholder="ìœ íŠœë¸Œ URL ë¶™ì—¬ë„£ê¸°">
                <button class="btn btn-primary" id="load-btn">ì¬ìƒ</button>
            </div>

            <div id="message" class="message"></div>

            <button class="btn btn-connect" id="connect-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                </svg>
                <span id="connect-text">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>
            </button>

            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">ì—°ê²° ì•ˆë¨</span>
            </div>

            <div class="button-row">
                <button class="btn btn-secondary" id="btn-speed-sync">
                    ğŸš€ ë°°ì† ì—°ë™
                </button>
                <button class="btn btn-secondary" id="btn-save-ride">
                    ğŸ’¾ ë¼ì´ë”© ì €ì¥
                </button>
            </div>

            <!-- ì´ ê¸°ë¡ -->
            <div class="total-stats">
                <div class="total-stat">
                    <div class="total-stat-value" id="total-distance">0</div>
                    <div class="total-stat-label">ì´ ê±°ë¦¬ (km)</div>
                </div>
                <div class="total-stat">
                    <div class="total-stat-value" id="total-calories">0</div>
                    <div class="total-stat-label">ì´ ì¹¼ë¡œë¦¬</div>
                </div>
                <div class="total-stat">
                    <div class="total-stat-value" id="total-rides">0</div>
                    <div class="total-stat-label">ì´ ë¼ì´ë”©</div>
                </div>
            </div>

            <!-- ë¼ì´ë”© ê¸°ë¡ -->
            <div class="ride-history">
                <h3>
                    ìµœê·¼ ë¼ì´ë”©
                    <button id="clear-history">ê¸°ë¡ ì‚­ì œ</button>
                </h3>
                <div class="ride-list" id="ride-list">
                    <div class="no-rides">ì•„ì§ ì €ì¥ëœ ë¼ì´ë”©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <p class="protocol-info">FTMS / CSC í”„ë¡œí† ì½œ ìë™ ê°ì§€</p>
        </div>
    </div>

    <script>
        // YouTube IFrame API ë¡œë“œ
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player = null;
        let isPlayerReady = false;
        let bluetoothDevice = null;
        let isConnected = false;
        let currentSpeed = 0;
        let currentCadence = 0;
        let currentPower = 0;
        let isPedalingActive = false;
        let speedSyncEnabled = false;
        let pedalingCheckInterval = null;
        let lastDataReceived = 0;

        // ë¼ì´ë”© ë°ì´í„°
        let rideStartTime = null;
        let totalDistance = 0;
        let totalCalories = 0;
        let rideTime = 0;
        let lastUpdateTime = null;

        // Bluetooth UUIDs
        const FTMS_SERVICE = '00001826-0000-1000-8000-00805f9b34fb';
        const FTMS_INDOOR_BIKE = '00002ad2-0000-1000-8000-00805f9b34fb';
        const CSC_SERVICE = '00001816-0000-1000-8000-00805f9b34fb';
        const CSC_MEASUREMENT = '00002a5b-0000-1000-8000-00805f9b34fb';

        // DOM ìš”ì†Œ
        const youtubeUrl = document.getElementById('youtube-url');
        const loadBtn = document.getElementById('load-btn');
        const connectBtn = document.getElementById('connect-btn');
        const connectText = document.getElementById('connect-text');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const speedValue = document.getElementById('speed-value');
        const cadenceValue = document.getElementById('cadence-value');
        const powerValue = document.getElementById('power-value');
        const distanceValue = document.getElementById('distance-value');
        const caloriesValue = document.getElementById('calories-value');
        const timeValue = document.getElementById('time-value');
        const dashboard = document.getElementById('dashboard');
        const handlebar = document.getElementById('handlebar');
        const placeholder = document.getElementById('placeholder');
        const pauseOverlay = document.getElementById('pause-overlay');
        const message = document.getElementById('message');
        const speedBlur = document.getElementById('speed-blur');
        const playbackRateDisplay = document.getElementById('playback-rate');
        const btnSpeedSync = document.getElementById('btn-speed-sync');
        const btnSaveRide = document.getElementById('btn-save-ride');
        const rideList = document.getElementById('ride-list');

        // ì €ì¥ëœ ê¸°ë¡ ë¡œë“œ
        loadHistory();

        // YouTube API ì¤€ë¹„ ì™„ë£Œ
        window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube API Ready');
        };

        // ìœ íŠœë¸Œ URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/]+)/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // ë¹„ë””ì˜¤ ë¡œë“œ
        loadBtn.addEventListener('click', () => {
            const url = youtubeUrl.value.trim();
            const videoId = extractVideoId(url);

            if (!videoId) {
                showMessage('ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            placeholder.style.display = 'none';

            if (player) {
                player.loadVideoById(videoId);
            } else {
                player = new YT.Player('youtube-player', {
                    videoId: videoId,
                    playerVars: {
                        playsinline: 1,
                        controls: 1,
                        rel: 0,
                        modestbranding: 1
                    },
                    events: {
                        onReady: () => {
                            isPlayerReady = true;
                            if (isConnected) {
                                showDashboard();
                            }
                        },
                        onStateChange: (event) => {
                            // ì˜ìƒ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
                        }
                    }
                });
            }

            showMessage('', '');
        });

        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        function showDashboard() {
            dashboard.style.display = 'flex';
            handlebar.style.display = 'block';
            playbackRateDisplay.style.display = 'block';
        }

        // ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°
        connectBtn.addEventListener('click', async () => {
            if (isConnected) {
                disconnect();
                return;
            }

            try {
                showMessage('ì¥ì¹˜ ê²€ìƒ‰ ì¤‘...', 'info');

                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [FTMS_SERVICE] },
                        { services: [CSC_SERVICE] }
                    ],
                    optionalServices: [FTMS_SERVICE, CSC_SERVICE]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await bluetoothDevice.gatt.connect();
                let connected = false;

                // FTMS ì‹œë„
                try {
                    const ftmsService = await server.getPrimaryService(FTMS_SERVICE);
                    const ftmsChar = await ftmsService.getCharacteristic(FTMS_INDOOR_BIKE);
                    await ftmsChar.startNotifications();
                    ftmsChar.addEventListener('characteristicvaluechanged', handleFTMSData);
                    connected = true;
                    showMessage('FTMS í”„ë¡œí† ì½œë¡œ ì—°ê²°ë¨', 'info');
                } catch (e) {
                    console.log('FTMS not available, trying CSC...');
                }

                // CSC ì‹œë„
                if (!connected) {
                    try {
                        const cscService = await server.getPrimaryService(CSC_SERVICE);
                        const cscChar = await cscService.getCharacteristic(CSC_MEASUREMENT);
                        await cscChar.startNotifications();
                        cscChar.addEventListener('characteristicvaluechanged', handleCSCData);
                        connected = true;
                        showMessage('CSC í”„ë¡œí† ì½œë¡œ ì—°ê²°ë¨', 'info');
                    } catch (e) {
                        console.log('CSC not available');
                    }
                }

                if (connected) {
                    setConnected(true);
                    resetRideData();
                    startPedalingCheck();
                } else {
                    throw new Error('ì§€ì›ë˜ëŠ” í”„ë¡œí† ì½œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

            } catch (error) {
                console.error('Connection error:', error);
                if (error.name !== 'NotFoundError') {
                    showMessage('ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
        });

        // í˜ë‹¬ë§ ì²´í¬ ì‹œì‘ (ì¼ì‹œì •ì§€ ê°ì§€ìš©)
        function startPedalingCheck() {
            if (pedalingCheckInterval) clearInterval(pedalingCheckInterval);
            
            pedalingCheckInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastData = now - lastDataReceived;
                
                // 2ì´ˆ ì´ìƒ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì†ë„/ì¼€ì´ë˜ìŠ¤ê°€ ë‚®ìœ¼ë©´ ë©ˆì¶¤ìœ¼ë¡œ íŒë‹¨
                if (timeSinceLastData > 2000 || (currentSpeed < 1 && currentCadence < 5)) {
                    if (isPedalingActive) {
                        isPedalingActive = false;
                        onStopPedaling();
                    }
                }
            }, 500);
        }

        // í˜ë‹¬ë§ ì²´í¬ ì¤‘ì§€
        function stopPedalingCheck() {
            if (pedalingCheckInterval) {
                clearInterval(pedalingCheckInterval);
                pedalingCheckInterval = null;
            }
        }

        // FTMS ë°ì´í„° ì²˜ë¦¬
        function handleFTMSData(event) {
            const value = event.target.value;
            const flags = value.getUint16(0, true);
            let offset = 2;

            currentSpeed = value.getUint16(offset, true) * 0.01;
            offset += 2;

            if (flags & 0x02) offset += 2;

            if (flags & 0x04) {
                currentCadence = value.getUint16(offset, true) * 0.5;
                offset += 2;
            }

            if (flags & 0x08) offset += 2;
            if (flags & 0x10) offset += 3;
            if (flags & 0x20) offset += 2;

            if (flags & 0x40) {
                currentPower = value.getInt16(offset, true);
                offset += 2;
            }

            lastDataReceived = Date.now();
            processData();
        }

        // CSC ë°ì´í„° ì²˜ë¦¬
        let lastWheelRevolutions = null;
        let lastWheelEventTime = null;
        let lastCrankRevolutions = null;
        let lastCrankEventTime = null;
        const WHEEL_CIRCUMFERENCE = 2.1;

        function handleCSCData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            let offset = 1;

            if (flags & 0x01) {
                const wheelRevolutions = value.getUint32(offset, true);
                const wheelEventTime = value.getUint16(offset + 4, true);
                offset += 6;

                if (lastWheelRevolutions !== null && wheelRevolutions !== lastWheelRevolutions) {
                    const revDiff = wheelRevolutions - lastWheelRevolutions;
                    let timeDiff = wheelEventTime - lastWheelEventTime;
                    if (timeDiff < 0) timeDiff += 65536;
                    
                    if (timeDiff > 0) {
                        const rpm = (revDiff / (timeDiff / 1024)) * 60;
                        currentSpeed = (rpm * WHEEL_CIRCUMFERENCE * 60) / 1000;
                    }
                } else if (lastWheelRevolutions !== null && wheelRevolutions === lastWheelRevolutions) {
                    // íœ ì´ ì•ˆ ëŒê³  ìˆìœ¼ë©´ ì†ë„ 0
                    currentSpeed = Math.max(0, currentSpeed - 0.5);
                }

                lastWheelRevolutions = wheelRevolutions;
                lastWheelEventTime = wheelEventTime;
            }

            if (flags & 0x02) {
                const crankRevolutions = value.getUint16(offset, true);
                const crankEventTime = value.getUint16(offset + 2, true);

                if (lastCrankRevolutions !== null && crankRevolutions !== lastCrankRevolutions) {
                    const revDiff = crankRevolutions - lastCrankRevolutions;
                    let timeDiff = crankEventTime - lastCrankEventTime;
                    if (timeDiff < 0) timeDiff += 65536;

                    if (timeDiff > 0) {
                        currentCadence = Math.round((revDiff / (timeDiff / 1024)) * 60);
                    }
                } else if (lastCrankRevolutions !== null && crankRevolutions === lastCrankRevolutions) {
                    // í¬ë­í¬ê°€ ì•ˆ ëŒê³  ìˆìœ¼ë©´ ì¼€ì´ë˜ìŠ¤ 0
                    currentCadence = Math.max(0, currentCadence - 5);
                }

                lastCrankRevolutions = crankRevolutions;
                lastCrankEventTime = crankEventTime;
            }

            lastDataReceived = Date.now();
            processData();
        }

        // ë°ì´í„° ì²˜ë¦¬ í†µí•©
        function processData() {
            const now = Date.now();
            
            // ê±°ë¦¬ ê³„ì‚° (km)
            if (lastUpdateTime && currentSpeed > 0) {
                const hoursDiff = (now - lastUpdateTime) / 3600000;
                totalDistance += currentSpeed * hoursDiff;
            }
            lastUpdateTime = now;

            // ì¹¼ë¡œë¦¬ ê³„ì‚° (ê°„ë‹¨í•œ ê³µì‹)
            if (currentPower > 0) {
                const hoursDiff = 1 / 3600; // 1ì´ˆ
                totalCalories += (currentPower * 3.6 * hoursDiff) / 4.184;
            } else if (currentSpeed > 0) {
                // íŒŒì›Œ ì—†ìœ¼ë©´ ì†ë„ ê¸°ë°˜ ì¶”ì •
                const hoursDiff = 1 / 3600;
                totalCalories += (currentSpeed * 7 * hoursDiff);
            }

            // ë¼ì´ë”© ì‹œê°„
            if (currentSpeed > 1 || currentCadence > 5) {
                if (!rideStartTime) rideStartTime = now;
                rideTime = Math.floor((now - rideStartTime) / 1000);
                
                // í™œì„± ìƒíƒœ
                if (!isPedalingActive) {
                    isPedalingActive = true;
                    onStartPedaling();
                }
            }

            updateDisplay();
            updatePlaybackRate();
            updateSpeedEffects();
        }

        // í˜ë‹¬ ì‹œì‘
        function onStartPedaling() {
            console.log('Start pedaling');
            if (isPlayerReady && player) {
                player.playVideo();
                pauseOverlay.classList.remove('visible');
            }
        }

        // í˜ë‹¬ ë©ˆì¶¤
        function onStopPedaling() {
            console.log('Stop pedaling');
            if (isPlayerReady && player) {
                player.pauseVideo();
                pauseOverlay.classList.add('visible');
            }
        }

        // ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            speedValue.textContent = currentSpeed.toFixed(1);
            cadenceValue.textContent = Math.round(currentCadence);
            powerValue.textContent = Math.round(currentPower);
            distanceValue.textContent = totalDistance.toFixed(2);
            caloriesValue.textContent = Math.round(totalCalories);
            
            const mins = Math.floor(rideTime / 60);
            const secs = rideTime % 60;
            timeValue.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ë°°ì† ì—…ë°ì´íŠ¸
        function updatePlaybackRate() {
            if (!speedSyncEnabled || !player || !isPlayerReady) return;

            let rate = 1.0;
            
            if (currentSpeed < 10) {
                rate = 0.75;
            } else if (currentSpeed < 20) {
                rate = 1.0;
            } else if (currentSpeed < 30) {
                rate = 1.25;
            } else {
                rate = 1.5;
            }

            player.setPlaybackRate(rate);
            playbackRateDisplay.textContent = rate.toFixed(2) + 'x';
            
            playbackRateDisplay.className = 'playback-rate';
            if (rate > 1.0) playbackRateDisplay.classList.add('fast');
            else if (rate < 1.0) playbackRateDisplay.classList.add('slow');
            else playbackRateDisplay.classList.add('normal');
        }

        // ì†ë„ íš¨ê³¼
        function updateSpeedEffects() {
            // ì†ë„ì— ë”°ë¥¸ ë¸”ëŸ¬ íš¨ê³¼
            const blurIntensity = Math.min(currentSpeed / 40, 1);
            speedBlur.style.opacity = blurIntensity * 0.5;
        }

        // ë°°ì† ì—°ë™ í† ê¸€
        btnSpeedSync.addEventListener('click', () => {
            speedSyncEnabled = !speedSyncEnabled;
            btnSpeedSync.classList.toggle('active', speedSyncEnabled);
            
            if (!speedSyncEnabled && player && isPlayerReady) {
                player.setPlaybackRate(1.0);
                playbackRateDisplay.textContent = '1.00x';
                playbackRateDisplay.className = 'playback-rate normal';
            }
        });

        // ë¼ì´ë”© ì €ì¥
        btnSaveRide.addEventListener('click', () => {
            if (totalDistance < 0.01) {
                showMessage('ì €ì¥í•  ë¼ì´ë”© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const ride = {
                date: new Date().toISOString(),
                distance: totalDistance.toFixed(2),
                calories: Math.round(totalCalories),
                time: rideTime
            };

            const history = JSON.parse(localStorage.getItem('bikeHistory') || '[]');
            history.unshift(ride);
            if (history.length > 20) history.pop();
            localStorage.setItem('bikeHistory', JSON.stringify(history));

            loadHistory();
            resetRideData();
            showMessage('ë¼ì´ë”©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'info');
        });

        // ê¸°ë¡ ë¡œë“œ
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('bikeHistory') || '[]');
            
            if (history.length === 0) {
                rideList.innerHTML = '<div class="no-rides">ì•„ì§ ì €ì¥ëœ ë¼ì´ë”©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                rideList.innerHTML = history.slice(0, 5).map(ride => {
                    const date = new Date(ride.date);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const mins = Math.floor(ride.time / 60);
                    return `
                        <div class="ride-item">
                            <span class="ride-item-date">${dateStr}</span>
                            <div class="ride-item-stats">
                                <span>${ride.distance}km</span>
                                <span>${ride.calories}kcal</span>
                                <span>${mins}ë¶„</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ì´ ê¸°ë¡ ê³„ì‚°
            const totals = history.reduce((acc, ride) => ({
                distance: acc.distance + parseFloat(ride.distance),
                calories: acc.calories + ride.calories,
                rides: acc.rides + 1
            }), { distance: 0, calories: 0, rides: 0 });

            document.getElementById('total-distance').textContent = totals.distance.toFixed(1);
            document.getElementById('total-calories').textContent = totals.calories;
            document.getElementById('total-rides').textContent = totals.rides;
        }

        // ê¸°ë¡ ì‚­ì œ
        document.getElementById('clear-history').addEventListener('click', () => {
            if (confirm('ëª¨ë“  ë¼ì´ë”© ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('bikeHistory');
                loadHistory();
            }
        });

        // ë¼ì´ë”© ë°ì´í„° ë¦¬ì…‹
        function resetRideData() {
            totalDistance = 0;
            totalCalories = 0;
            rideTime = 0;
            rideStartTime = null;
            lastUpdateTime = null;
            updateDisplay();
        }

        // ì—°ê²° ìƒíƒœ ì„¤ì •
        function setConnected(connected) {
            isConnected = connected;
            statusDot.classList.toggle('connected', connected);
            connectBtn.classList.toggle('connected', connected);
            
            if (connected) {
                statusText.textContent = bluetoothDevice.name || 'ì—°ê²°ë¨';
                connectText.textContent = 'ì—°ê²° í•´ì œ';
                if (isPlayerReady) {
                    showDashboard();
                }
                // ì—°ê²° ì‹œ ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                pauseOverlay.classList.add('visible');
            } else {
                statusText.textContent = 'ì—°ê²° ì•ˆë¨';
                connectText.textContent = 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°';
                dashboard.style.display = 'none';
                handlebar.style.display = 'none';
                playbackRateDisplay.style.display = 'none';
                pauseOverlay.classList.remove('visible');
            }
        }

        // ì—°ê²° í•´ì œ
        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            stopPedalingCheck();
        }

        // ì—°ê²° ëŠê¹€ í•¸ë“¤ëŸ¬
        function onDisconnected() {
            setConnected(false);
            stopPedalingCheck();
            currentSpeed = 0;
            currentCadence = 0;
            currentPower = 0;
            isPedalingActive = false;
            updateDisplay();
            showMessage('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'message' + (type ? ' ' + type : '');
        }

        // URL ì…ë ¥ ì—”í„°í‚¤ ì²˜ë¦¬
        youtubeUrl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadBtn.click();
        });
    </script>
</body>
</html>
